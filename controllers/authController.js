import { getPool } from "../config/db.js";
import bcrypt from "bcryptjs";

// üîê Login con comparaci√≥n de contrase√±a hasheada
export const login = async (req, res) => {
  try {
    const { correo, contrasena } = req.body;

    console.log("üì• Solicitud de login recibida");

    if (!correo || !contrasena) {
      console.warn("‚ö†Ô∏è Correo o contrase√±a no proporcionados");
      return res.status(400).json({ message: "Correo y contrase√±a son requeridos" });
    }

    // ‚úÖ Usamos el pool global
    const pool = await getPool();
    console.log("‚úÖ Conexi√≥n al pool de la base de datos establecida");

    const [rows] = await pool.execute(
      `SELECT * FROM usuarios WHERE correo = ?`,
      [correo.toLowerCase()]
    );

    const user = rows[0];

    if (!user) {
      console.warn("‚ùå Usuario no encontrado para el correo proporcionado");
      return res.status(404).json({ message: "Usuario no encontrado" });
    }

    console.log("üîë Verificando contrase√±a...");

    const passwordIsValid = await bcrypt.compare(contrasena, user.contrasena);

    if (!passwordIsValid) {
      console.warn("‚ùå Contrase√±a inv√°lida");
      return res.status(401).json({ message: "Contrase√±a incorrecta" });
    }

    console.log("‚úÖ Usuario autenticado correctamente");

    res.status(200).json({
      message: "Inicio de sesi√≥n exitoso",
      user: {
        id: user.id_usuario,
        usuario: user.usuario,
        correo: user.correo,
        rol: user.rol,
        id_referencia: user.id_referencia,
      },
    });

  } catch (err) {
    console.error("‚ùó Error interno al iniciar sesi√≥n:", err.message);
    res.status(500).json({ message: "Error del servidor al iniciar sesi√≥n" });
  }
};
